import{i as le}from"./datatables-ChBcC82Q.js";import{c as de}from"./modal-X6AMKalI.js";async function D(e){const t=await fetch(e,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`GET ${e} failed with status ${t.status}`);return await t.json()}async function Y(e,t=null){const n={method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}};t&&(n.body=t);const i=await fetch(e,n);if(!i.ok)throw new Error(`Request gagal: ${i.status}`);return await i.json()}async function C(e,t){console.log("post form data",t);const a=await fetch(e,{method:"POST",body:t,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}),n=await a.json();if(!a.ok){const i=new Error(n.message||"Terjadi kesalahan pada server");throw i.status=a.status,i}return n}const W=async(e,t,a)=>{$(".u-modal").fadeOut(150,function(){$(this).addClass("hidden").hide()}),console.log("note abcd",a);try{Swal.fire({title:"Memproses...",text:"Mohon tunggu sebentar.",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const n=new FormData;n.append("note",a||"");const i=await Y(e,n);if(i.status==="success"||i.ok)await Swal.fire({icon:"success",title:"Berhasil!",text:i.message||"Data berhasil disetuui.",timer:1500,showConfirmButton:!1}),$(".u-modal").fadeOut(200,function(){$(this).addClass("hidden")}),typeof t=="function"&&t();else throw new Error(i.message||"Gagal menyetujui data.")}catch(n){console.error("Approve Error:",n),Swal.fire({icon:"error",title:"Gagal",text:n.message||"Terjadi kesalahan sistem."})}},ce=async(e,t,a)=>{const n=`/training/training-management/${e}/approve-training-submission`;console.log("1111note",a),await W(n,t,a)},ue=async(e,t,a)=>{const n=`/training/training-management/${e}/approve-training-reference`;await W(n,t,"menerima pengajuan")},X=async(e,t,a,n)=>{$(".u-modal").fadeOut(150,function(){$(this).addClass("hidden").hide()});try{Swal.fire({title:"Memproses Penolakan...",text:"Mohon tunggu sebentar.",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const i=new FormData;i.append("note",n||"");const r=await Y(e,i);if(Swal.close(),r.status==="success"||r.ok)await Swal.fire({icon:"success",title:"Ditolak",text:r.message||"Data berhasil ditolak.",timer:1500,showConfirmButton:!1}),typeof a=="function"&&a();else throw new Error(r.message||"Gagal menolak data.")}catch(i){Swal.close(),console.error("Reject Error:",i),Swal.fire({icon:"error",title:"Gagal",text:i.message||"Terjadi kesalahan sistem."})}},pe=async(e,t,a)=>{const n=`/training/training-management/${e}/reject-training-submission`;await X(n,"Tolak Permintaan Training?",t,a)},fe=async(e,t,a)=>{const n=`/training/training-management/${e}/reject-training-pengajuan`;await X(n,"Tolak Pengajuan Training?",t,a)};function j(e,t="success",a=5e3){const n=document.getElementById("app-toast");if(!n)return;const i={success:'<i class="fas fa-check-circle text-green-500"></i>',error:'<i class="fas fa-exclamation-circle text-red-500"></i>',info:'<i class="fas fa-info-circle text-blue-500"></i>'};n.innerHTML=`
        <div style="font-size: 1.2rem;">${i[t]||i.info}</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 14px; margin-bottom: 2px;">${t.toUpperCase()}</div>
            <div style="font-size: 13px; opacity: 0.9;">${e}</div>
        </div>
    `,n.className=`app-toast ${t} show`,setTimeout(()=>{n.classList.replace("show","hidden")},a)}function me({title:e="Konfirmasi Tindakan",text:t="Apakah Anda yakin ingin melanjutkan?",confirmText:a="Ya, Lanjutkan",cancelText:n="Batalkan"}={}){return new Promise(i=>{const r=document.getElementById("confirm-toast-root");if(!r)return i(!1);const o=document.createElement("div");o.className="confirm-toast-overlay";const d=document.createElement("div");d.className="confirm-toast",d.innerHTML=`
            <div style="font-size: 4.5rem; margin-bottom: 20px; color: #f59e0b; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                <i class="fas fa-warning"></i>
            </div>
            <div class="confirm-toast__title">${e}</div>
            <div class="confirm-toast__text">${t}</div>
            <div class="u-flex u-gap-md justify-center">
                <button class="u-btn u-btn--accent cancel" style="width: 100px">${n}</button>
                <button class="u-btn confirm" style="width: 130px; background: #641313; color: white;">${a}</button>
            </div>
        `,r.appendChild(o),r.appendChild(d),setTimeout(()=>{d.style.transform="translate(-50%, -50%) scale(1)"},10);const p=u=>{d.style.transform="translate(-50%, -50%) scale(0.9)",d.style.opacity="0",setTimeout(()=>{d.remove(),o.remove(),i(u)},200)};d.querySelector(".cancel").onclick=u=>{u.preventDefault(),u.stopPropagation(),p(!1)},d.querySelector(".confirm").onclick=u=>{u.preventDefault(),u.stopPropagation(),p(!0)}})}const Q={"data-lna-table":{tableId:"data-lna-table",modalId:"#lna-modal",apiEndpoint:()=>"/training/training-request/get-data-lna",columns:["no","judul_sertifikasi","unit_kerja","penyelenggara","jumlah_jam","waktu_pelaksanaan","biaya_pelatihan","nama_proyek","jenis_portofolio","jenis_pelatihan","fungsi","status_training_reference","actions"],dataMapper:e=>e.data||[]},"approval-pengajuan-training-table":{tableId:"approval-pengajuan-training-table",modalId:"#pengajuan-training-modal",apiEndpoint:()=>"/training/training-request/get-approval-pengajuan-training",columns:["no","judul_sertifikasi","unit_kerja","penyelenggara","jumlah_jam","waktu_pelaksanaan","biaya_pelatihan","nama_proyek","jenis_portofolio","jenis_pelatihan","fungsi","status_training_reference","actions"],dataMapper:e=>e.data||[]},"approval-training-request-table":{tableId:"approval-training-request-table",modalId:"#training-peserta-modal",apiEndpoint:()=>"/training/training-request/get-training-request-list",columns:["no","judul_sertifikasi","peserta","tanggal_mulai","tanggal_berakhir","realisasi_biaya_pelatihan","lampiran_penawaran","status_approval_training","actions"],dataMapper:e=>e.data||[]},"pengajuan-training-peserta-table":{tableId:"pengajuan-training-peserta-table",modalId:"#training-peserta-modal",apiEndpoint:e=>`/training/training-management/${e}/get-pengajuan-training-peserta`,columns:["no","judul_sertifikasi","peserta","tanggal_mulai","tanggal_berakhir","realisasi_biaya_pelatihan","lampiran_penawaran","status_approval_training","actions"],dataMapper:e=>e.data||[]},"pengajuan-data-lna-table":{tableId:"pengajuan-data-lna-table",modalId:"#lna-modal",apiEndpoint:()=>"/training/training-management/get-data-pengajuan-lna",columns:["no","judul_sertifikasi","unit_kerja","penyelenggara","jumlah_jam","waktu_pelaksanaan","biaya_pelatihan","nama_proyek","jenis_portofolio","jenis_pelatihan","fungsi","status_training_reference","actions"],dataMapper:e=>e.data||[]}},J={no:(e,t,a,n)=>`<div class="text-center"><div class="u-badge u-badge--primary">${n.row+1}</div></div>`,judul_sertifikasi:(e,t,a)=>`<div class="u-font-medium">${a.judul_sertifikasi??"-"}</div>`,peserta:(e,t,a)=>`
        <div class="flex flex-col">
            <span class="font-semibold">${a.peserta}</span>
            <small class="text-gray-500">${a.nik}</small>
        </div>`,tanggal_mulai:e=>`<div>${I(e)}</div>`,tanggal_berakhir:e=>`<div>${I(e)}</div>`,biaya_pelatihan:e=>`<div>${E(e)}</div>`,realisasi_biaya_pelatihan:e=>`<div>${E(e)}</div>`,estimasi_total_biaya:e=>`<div class="font-bold u-text-sm">${E(e)}</div>`,lampiran_penawaran:e=>{const t=e&&e!=="null"&&e!=="";return`<div><span class="u-badge ${t?"u-badge--success":"u-badge--danger"}">${t?"Tersedia":"Kosong"}</span></div>`},status_approval_training:e=>V(e),status_training_reference:e=>V(e),actions:(e,t,a,n,i)=>`
        <div class="">
            <button type="button" class="u-btn u-btn--xs u-btn--outline btn-trigger-modal" 
                data-table="${i.tableId}">
                <i class="fas fa-eye"></i> Detail
            </button>
        </div>`},ge=()=>{const e=$("body");e.off("click.modalSystem").on("click.modalSystem",".btn-trigger-modal",function(){const a=$(this),n=a.data("table"),i=Q[n];if(!i)return;const r=v[n];if(!r)return;const d=r.row(a.parents("tr")).data(),p=$(i.modalId);p.attr("data-table-id",n),p.length&&d&&(P(p,!1),he(p,d),d.status_training_reference==="cancelled"?(p.find("#btn-toggle-edit").addClass("hidden"),p.find("#btn-submit-action").addClass("hidden"),p.find(".edit-indicator").text("Data tidak aktif (Read Only)").addClass("text-red-600")):(p.find("#btn-toggle-edit").removeClass("hidden"),p.find("#btn-submit-action").removeClass("hidden"),p.find(".edit-indicator").text("Pratinjau Data").removeClass("text-red-600")),p.removeAttr("hidden").removeClass("is-hidden").removeClass("hidden"),$("body").addClass("modal-open"))}),e.on("click","#btn-toggle-edit",function(){const a=$(this).closest(".u-modal"),n=a.hasClass("is-editing-active");P(a,!n)}),e.on("click","#btn-submit-action",function(){const a=$(this).closest(".u-modal");if(ee(a)){Swal.fire("Info","Data sudah tidak aktif","info");return}const n=a.hasClass("is-editing-active"),i=a.attr("data-current-id");if(n){const r=a.find("#lna-detail-form").serialize();be(i,r,a)}else we(i,a)});const t=a=>{!a||!a.length||a.hasClass("is-hidden")||a.is("[hidden]")||(a.addClass("is-hidden"),setTimeout(()=>{a.attr("hidden",!0),e.removeClass("modal-open")}))};e.on("click",".js-close-modal",function(a){a.preventDefault(),a.stopPropagation(),t($(this).closest(".u-modal"))}),window.addEventListener("keydown",a=>{if(a.key!=="Escape")return;const n=$(".u-modal:not([hidden]):not(.is-hidden)").last();n.length&&(a.preventDefault(),a.stopPropagation(),t(n))},!0),e.on("click","#btn-approve-request",function(){const a=$(this).closest(".u-modal"),n=a.attr("data-current-id"),i=a.attr("id"),r=a.find("#catatan").val(),o=()=>{const d=a.attr("data-table-id");d&&A.reload(d)};i==="training-peserta-modal"?ce(n,o,r):ue(n,o)}),e.on("click","#btn-decline-request",function(){const a=$(this).closest(".u-modal"),n=a.attr("data-current-id"),i=a.attr("id"),r=a.find("#catatan").val(),o=()=>{const d=a.attr("data-table-id");d&&A.reload(d)};i==="training-peserta-modal"?pe(n,o,r):fe(n,o,r)})},he=(e,t)=>{e.attr("data-current-id",t.id),e.attr("data-status",t.status_training_reference),e.find("#edit-id").val(t.id),e.find(".detail-judul-text, .detail-judul_sertifikasi").text(t.judul_sertifikasi||"-"),e.find(".detail-unit, .detail-unit_kerja").text(t.unit_kerja||"-"),e.find(".detail-penyelenggara").text(t.penyelenggara||"-"),e.find(".detail-jumlah_jam").text(t.jumlah_jam||"-"),e.find(".detail-no").text(t.no||"-"),e.find(".detail-status_training_reference").text(`Status: ${t.status_training_reference||"-"}`),e.find(".detail-status_approval_training").text(`Status: ${t.status_approval_training||"-"}`),e.find(".detail-waktu_pelaksanaan").text(t.waktu_pelaksanaan||"-"),e.find(".detail-tanggal_mulai").text(I(t.tanggal_mulai)||"-"),e.find(".detail-tanggal_berakhir").text(I(t.tanggal_berakhir)||"-"),e.find(".detail-proyek, .detail-nama_proyek").text(t.nama_proyek||"-"),e.find(".detail-fungsi").text(t.fungsi||"-"),e.find(".detail-portofolio, .detail-jenis_portofolio").text(t.jenis_portofolio||"-"),e.find(".detail-jenis_pelatihan, .detail-jenis_pelatihan").text(t.jenis_pelatihan||"-"),e.find(".detail-biaya_pelatihan").text(E(t.biaya_pelatihan||0)),e.find(".detail-realisasi_biaya_pelatihan").text(E(t.realisasi_biaya_pelatihan||0)),e.find("#catatan").val(""),ye(t.approvals||[]);const a=t.peserta||t.nama_peserta;if(a?(e.find(".section-peserta").show(),e.find(".detail-peserta").text(a)):e.find(".section-peserta").hide(),t.lampiran_penawaran){const n=t.lampiran_penawaran,i=n.split(".").pop().toLowerCase(),r=`/training/training-request/${n}`;let o="fa-file-alt";i==="pdf"?o="fa-file-pdf text-red-500":["jpg","jpeg","png"].includes(i)&&(o="fa-file-image text-blue-500"),e.find(".detail-lampiran_penawaran").html(`
        <a href="${r}" target="_blank" class="u-btn u-btn--sm u-btn--light border u-hover-lift">
            <i class="fas ${o} u-mr-xs"></i> Lihat Lampiran (${i.toUpperCase()})
        </a>
    `)}else e.find(".detail-lampiran_penawaran").html('<span class="u-muted u-text-sm italic">Tidak ada lampiran</span>')},P=(e,t)=>{ee(e)||(t?(e.addClass("is-editing-active"),e.find(".view-mode").addClass("hidden"),e.find(".edit-mode").removeClass("hidden"),e.find('input[name="penyelenggara"]').val(e.find(".detail-penyelenggara").text().trim()),e.find('input[name="jumlah_jam"]').val(e.find(".detail-jumlah_jam").text().trim()),e.find('input[name="waktu_pelaksanaan"]').val(e.find(".detail-waktu_pelaksanaan").text().trim()),e.find('input[name="nama_proyek"]').val(e.find(".detail-nama_proyek").text().trim()),e.find('input[name="fungsi"]').val(e.find(".detail-fungsi").text().trim()),e.find('input[name="jenis_portofolio"]').val(e.find(".detail-jenis_portofolio").text().trim()),e.find('select[name="jenis_pelatihan"]').val(e.find(".detail-jenis_pelatihan").text().trim()),e.find('input[name="biaya_pelatihan"]').val(e.find(".detail-biaya_pelatihan").text().replace(/[^0-9]/g,"")),e.find("#btn-toggle-edit span").text("Batal"),e.find("#btn-submit-action span").text("Simpan Perubahan"),e.find("#btn-submit-action").addClass("u-btn--brand u-btn--fill").removeClass("u-btn--outline")):(e.removeClass("is-editing-active"),e.find(".view-mode").removeClass("hidden"),e.find(".edit-mode").addClass("hidden"),e.find("#btn-toggle-edit span").text("Edit"),e.find("#btn-submit-action span").text("Hapus"),e.find("#btn-submit-action").removeClass("u-btn--brand u-btn--fill").addClass("u-btn--outline")))};let K=!1;const v={},A={get(e){return v[e]||null},reload(e){const t=v[e];t&&t.ajax.reload(null,!1)},reloadAll(){Object.values(v).forEach(e=>{e.ajax.reload(null,!1)})}};function Z(e,t={}){const a=$(e);if(!a.length)return;const n=a.attr("id"),i=Q[n];if(!i)return;if(v[n])return v[n];K||(ge(),K=!0);const r=le(`#${n}`,{serverSide:!0,ajax:async(o,d)=>{const p=new URLSearchParams({page:o.start/o.length+1,per_page:o.length,search:o.search.value,order_by:o.columns[o.order[0]?.column]?.data||"",order_dir:o.order[0]?.dir||""});try{const u=await D(`${i.apiEndpoint(t.unitId)}?${p}`);d({draw:o.draw,recordsTotal:u.pagination?.total||0,recordsFiltered:u.pagination?.total||0,data:i.dataMapper(u)})}catch{d({draw:o.draw,data:[],recordsTotal:0,recordsFiltered:0})}},columns:i.columns.map(o=>({data:["no","actions","peserta"].includes(o)?null:o,render:(d,p,u,m)=>J[o]?J[o](d,p,u,m,i):d??"-"}))});return v[n]=r,r}const be=(e,t,a)=>{const n=a.find("#btn-submit-action"),i=n.html();$.ajax({url:`/training/training-request/${e}/edit-data-lna`,method:"POST",data:t,beforeSend:()=>{n.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin u-mr-xs"></i> Menyimpan...')},success:r=>{j(r.message||"Data berhasil diperbarui","success"),setTimeout(()=>{a.fadeOut(200,function(){$(this).addClass("hidden").hide(),P(a,!1)})},1500),$.fn.DataTable.isDataTable(".dataTable")&&$(".dataTable").DataTable().ajax.reload(null,!1)},error:r=>{const o=r.responseJSON?.message||"Terjadi kesalahan sistem";j(o,"error")},complete:()=>{n.prop("disabled",!1).html(i)}})},ye=(e=[])=>{const t=$("#approval-timeline-container");if(t.empty(),!e.length){t.append(`
            <div class="u-text-center u-py-md u-muted u-text-xs italic">
                Belum ada riwayat
            </div>
        `);return}e.forEach(a=>{const n=a.to_status||a.action||"-",i=a.user_name??"System",r=n==="approved",o=n==="rejected",d=r?"text-green-600":o?"text-red-600":"text-sky-600",p=r?"#16a34a":o?"#dc2626":"#0284c7",u=a.created_at?new Date(a.created_at).toLocaleString("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-";t.append(`
            <div class="u-mb-md u-pl-md u-relative border-l-2 border-gray-200">
                <span class="u-absolute"
                    style="
                        left:-7px;
                        top:4px;
                        width:12px;
                        height:12px;
                        border-radius:50%;
                        background:#fff;
                        border:2px solid ${p};
                    ">
                </span>

                <div class="u-flex u-justify-between">
                    <span class="u-text-xs u-font-semibold ${d}">
                        ${i} (${a.role})
                    </span>
                    <span class="u-text-xs u-muted">${u}</span>
                </div>

                <div class="u-text-xs u-mt-[2px]">
                    Ke Status:
                    <span class="u-font-semibold ${d}">
                        ${n.replace(/_/g," ")}
                    </span>
                </div>

                ${a.note?`<div class="u-text-xs italic text-gray-600 u-mt-[2px]">
                            “${a.note}”
                           </div>`:""}
            </div>
        `)})},we=async(e,t)=>{await me({title:"Yakin ingin menghapus?",text:"Data yang dihapus akan dinonaktifkan.",confirmText:"Hapus",cancelText:"Batal"})&&(j("Menghapus data...","info"),$.ajax({url:`/training/training-request/${e}/delete-lna`,method:"POST",data:{_method:"DELETE",_token:$('meta[name="csrf-token"]').attr("content")},success:n=>{t.fadeOut(200,function(){$(this).addClass("hidden").hide()}),j(n.message,"success"),$.fn.DataTable.isDataTable(".dataTable")&&$(".dataTable").DataTable().ajax.reload(null,!1)},error:n=>{j(n.responseJSON?.message||"Terjadi kesalahan","error")}}))};function E(e){return e?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(Number(e)):""}const I=e=>e?new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"}):"-",ee=e=>e.attr("data-status")==="cancelled",V=e=>{const a={approved:{label:"Approved",class:"bg-emerald-100 text-emerald-700 border border-emerald-200"},rejected:{label:"Rejected",class:"bg-red-100 text-red-700 border border-red-200"},in_review_gmvp:{label:"In Review GM/VP",class:"bg-sky-100 text-sky-700 border border-sky-200"},in_review_dhc:{label:"In Review DHC",class:"bg-sky-100 text-sky-700 border border-sky-200"},in_review_avpdhc:{label:"In Review AVP DHC",class:"bg-sky-100 text-sky-700 border border-sky-200"},in_review_vpdhc:{label:"In Review VP DHC",class:"bg-sky-100 text-sky-700 border border-sky-200"},active:{label:"Aktif",class:"bg-green-100 text-green-700 border border-green-200"},pending:{label:"Pending",class:"bg-yellow-100 text-yellow-700 border border-yellow-200"},cancelled:{label:"Cancelled",class:"bg-slate-100 text-slate-600 border border-slate-200"}}[e]||{label:e||"-",class:"bg-gray-100 text-gray-600 border border-gray-200"};return`
        <span class="
            inline-flex items-center gap-1.5
            px-3 py-1
            rounded-full text-xs font-semibold
            whitespace-nowrap
            ${a.class}
        ">
            ${a.label}
        </span>
    `};function ve(e){if(console.log("Initializing input handler",e),!e)return;const t=document.querySelector("#add-form");if(!t)return;const a=t.querySelector("select[name='judul_sertifikasi']"),n=t.querySelector("input[name='penyelenggara']"),i=t.querySelector("input[name='jumlah_jam']"),r=t.querySelector("input[name='jenis_pelatihan']"),o=t.querySelector("input[name='jenis_portofolio']"),d=t.querySelector("input[name='waktu_pelaksanaan']"),p=t.querySelector("input[name='nama_proyek']"),u=t.querySelector("input[name='biaya_pelatihan']"),m=t.querySelector("input[name='realisasi_biaya_pelatihan']"),g=t.querySelector("#toggle-realisasi"),b=t.querySelector("input[name='start_date']"),_=t.querySelector("input[name='end_date']"),F=document.getElementById("peserta-search"),k=document.getElementById("peserta-dropdown"),q=document.getElementById("peserta-selected"),te=document.getElementById("peserta-list-hidden");let B=[],R=[],h=[];function N(s){if(s==null||s===""||s==="-")return"";let l=s.toString();(l.endsWith(".00")||l.endsWith(".0"))&&(l=l.split(".")[0]);const c=l.replace(/\D/g,"");return c?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(parseInt(c,10)):""}function U(s){if(!s)return 0;const l=s.toString().replace(/[^\d]/g,"");return l?parseInt(l,10):0}function T(s){if(!s)return"";const l=s.name||s.person_name||s.full_name||"",c=s.employee_id||"";return c?`${l} - ${c}`:l}function H(s){return!s&&s!==0?null:s.id??s.person_id??null}function z(){q.innerHTML="",h.forEach(s=>{const l=document.createElement("div");l.classList.add("chip"),l.innerHTML=`
                ${s.name}
                <button type="button" class="chip-remove" data-id="${s.id??""}" data-name="${s.name}">x</button>
            `,q.appendChild(l)}),q.querySelectorAll(".chip-remove").forEach(s=>{s.addEventListener("click",l=>{const c=l.currentTarget.getAttribute("data-id"),f=l.currentTarget.getAttribute("data-name");ne(c,f)})}),te.value=JSON.stringify(h)}function ae(s){const l=T(s),c=H(s);(c?h.some(w=>w.id===c):h.some(w=>w.name===l))||(h.push({id:c,name:l}),z()),F.value="",k.style.display="none"}function ne(s,l){s&&s!=="null"?h=h.filter(c=>String(c.id)!==String(s)):h=h.filter(c=>c.name!==l),z()}function ie(){g&&g.addEventListener("change",function(){this.checked?(m.readOnly=!1,m.classList.remove("u-bg-gray-100","u-text-gray-500","u-pointer-events-none"),m.value="",m.focus()):(m.readOnly=!0,m.classList.add("u-bg-gray-100","u-text-gray-500","u-pointer-events-none"),m.value=u.value)}),[u,m].forEach(s=>{s.addEventListener("input",l=>{const c=N(l.target.value);l.target.value=c,s.name==="biaya_pelatihan"&&g&&!g.checked&&(m.value=c)})}),F.addEventListener("keyup",function(){const s=this.value.toLowerCase();if(s.length===0){k.style.display="none";return}const l=R.filter(c=>{const f=T(c).toLowerCase(),w=H(c),M=w?h.some(S=>S.id===w):h.some(S=>S.name===T(c));return f.includes(s)&&!M});if(k.innerHTML="",l.length===0){k.style.display="none";return}l.forEach(c=>{const f=document.createElement("div");f.className="dropdown-item",f.textContent=T(c),f.addEventListener("click",()=>ae(c)),k.appendChild(f)}),k.style.display="block"}),a.addEventListener("change",()=>{const s=parseInt(a.value),l=B.find(f=>f.id===s);if(!l){[n,i,r,o,d,p,u,m,b,_].forEach(f=>{f&&(f.value="-")});return}n.value=y(l.penyelenggara),i.value=y(l.jumlah_jam),r.value=y(l.jenis_pelatihan),o.value=y(l.jenis_portofolio),d.value=y(l.waktu_pelaksanaan),p.value=y(l.nama_proyek);const c=N(l.biaya_pelatihan);u.value=c,g&&!g.checked&&(m.value=c),b.value=y(G(l.start_date)),_.value=y(G(l.end_date))}),t.addEventListener("submit",async s=>{s.preventDefault();const l=Object.fromEntries(new FormData(s.target)),c=U(l.biaya_pelatihan),f=U(l.realisasi_biaya_pelatihan),w=f>0?f:c,M={judul_sertifikasi:parseInt(l.judul_sertifikasi),penyelenggara:x(l.penyelenggara),jumlah_jam:parseInt(l.jumlah_jam)||0,jenis_pelatihan:x(l.jenis_pelatihan),jenis_portofolio:x(l.jenis_portofolio),waktu_pelaksanaan:x(l.waktu_pelaksanaan),nama_proyek:x(l.nama_proyek),biaya_pelatihan:c,realisasi_biaya_pelatihan:w,start_date:l.start_date,end_date:l.end_date,peserta_list:JSON.parse(l.peserta_list||"[]")},S=oe(s.target,M);try{e.classList.add("hidden"),Swal.fire({title:"Menyimpan...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const O=await C("/training/training-request/input-training-request",S);Swal.close(),O.status==="success"?(await Swal.fire({icon:"success",title:"Berhasil!",timer:2e3,showConfirmButton:!1}),window.location.reload()):Swal.fire("Gagal",O.message,"error")}catch{Swal.fire("Error","Terjadi kesalahan server","error")}})}async function re(){try{const s=await D(`/training/training-request/training-references/${window.userUnitId}`);s.status==="success"&&(B=s.data,a.innerHTML='<option value="">-- Pilih Judul Sertifikasi --</option>'+B.map(l=>`<option value="${l.id}">${l.judul_sertifikasi}</option>`).join(""))}catch(s){console.error("Error load reference:",s)}}async function se(){try{const s=await D(`/training/training-request/${window.userUnitId}/get-employee-by-unit`);s.status==="success"&&(R=s.data)}catch(s){console.error("Error load peserta:",s)}}function y(s){return s==null||s===""?"-":s}function x(s){return s==="-"||s===""?null:s}function oe(s,l){const c=new FormData;c.append("data",JSON.stringify(l));const f=s.querySelector('input[name="lampiran_penawaran"]').files[0];return f&&c.append("lampiran_penawaran",f),c}function G(s){if(!s)return"-";const l=new Date(s);return isNaN(l)?"-":l.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"})}ie(),se(),re()}function _e(e){if(!e)return;const t=document.querySelector("#lna-input-form");ke(),a(t),t.addEventListener("submit",async function(n){n.preventDefault();const i=new FormData(t);Swal.fire({title:"Menyimpan...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{e.classList.add("hidden"),Swal.fire({title:"Menyimpan Data...",text:"Harap tunggu sebentar.",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const r=await C("/training/training-request/input-lna",i);if(Swal.close(),r.status==="success"){await Swal.fire({icon:"success",title:"Berhasil!",text:r.message||"Data berhasil disimpan.",timer:2e3,showConfirmButton:!1}),t.reset(),window.location.reload();return}Swal.fire({icon:"error",title:"Gagal Menyimpan",text:r.message||"Terjadi kesalahan saat menyimpan data."})}catch(r){Swal.close(),console.error("Error:",r),Swal.fire({icon:"error",title:"Kesalahan Server",text:"Terjadi kesalahan pada server. Silakan coba lagi."})}});function a(n){const i=n.querySelector("input[name='biaya_pelatihan']");if(!i){alert("Biaya handler: element tidak ditemukan di form");return}i.addEventListener("input",()=>{const o=i.value.replace(/[^\d]/g,"");i.value=r(o)});function r(o){return o?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(parseInt(o,10)):""}}}async function ke(){const e=document.getElementById("select-unit");if(e)try{const t=await D("/training/training-request/get-data-units");console.log("units",t),t.status==="success"?xe(e,t.data):console.warn("Gagal mendapatkan data unit")}catch(t){console.error("Error fetch units:",t)}}function xe(e,t){e.innerHTML='<option value="">-- Pilih Unit --</option>',t.forEach(a=>{const n=document.createElement("option");n.value=a.id,n.textContent=a.name,e.appendChild(n)})}async function Se(e){const t="/training/training-management/import-lna",n=Math.ceil(e.size/512e3);let i=null;for(let r=0;r<n;r++){const o=new FormData;o.append("chunk",e.slice(r*512e3,Math.min((r+1)*512e3,e.size))),o.append("index",r),o.append("total",n),o.append("filename",e.name);const d=await C(t,o);if(!d||d.status!=="success")throw new Error(d?.message||"Gagal mengunggah file.");i=d}return i}function je(e){if(!e)return;const t=document.getElementById("drag-drop-area"),a=document.getElementById("drag-drop-input"),n=document.getElementById("selected-file-info"),i=document.getElementById("dragdrop-wrapper"),r=document.getElementById("import-form");if(!r||r.dataset.initialized==="true")return;r.dataset.initialized="true";let o=null;if(!i||!t||!a||!r)return;let d=!1;t.addEventListener("click",u=>{if(o||d)return;d=!0;const m=()=>{d=!1,window.removeEventListener("focus",m)};window.addEventListener("focus",m),a.click()});function p(){o=null,a.value="",n.classList.add("hidden"),i.classList.remove("hidden"),t.classList.remove("border-blue-500","bg-blue-50"),t.classList.add("border-gray-200"),a.blur()}e&&e.addEventListener("modalClosed",p),a.addEventListener("change",()=>{o=a.files[0],o||(console.log("tidak ada file dipilih"),alert("tidak ada file dipilih")),i.classList.add("hidden"),n.classList.remove("hidden"),n.innerHTML=`
            <div class="bg-green-50 border border-green-300 u-p-lg rounded-lg flex items-center justify-between">
                <div>
                    <p class="text-green-700 font-medium">File Terpilih:</p>
                    <p class="text-green-800">${o.name}</p>
                </div>
                <div id="change-file-btn" class="u-btn u-btn--outline u-hover-lift">
                    Ganti File
                </div>
            </div>
        `,document.getElementById("change-file-btn").addEventListener("click",u=>{u.stopPropagation(),p()})}),t.addEventListener("dragover",u=>{u.preventDefault(),t.classList.remove("border-gray-200"),t.classList.add("border-blue-500","bg-blue-50")}),t.addEventListener("dragleave",()=>{t.classList.remove("border-blue-500","bg-blue-50")}),t.addEventListener("drop",u=>{u.preventDefault(),a.files=u.dataTransfer.files,a.dispatchEvent(new Event("change"))}),r.addEventListener("submit",async u=>{u.preventDefault();const m=()=>{e&&$(e).fadeOut(150,function(){$(this).addClass("hidden").hide(),e.classList.add("hidden")})};if(!o)return m(),Swal.fire({icon:"warning",title:"Peringatan",text:"Pilih file terlebih dahulu!",confirmButtonText:"Oke"});m(),Swal.fire({title:"Mengunggah Data...",text:"Harap tunggu, sedang memproses file.",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{const g=await Se(o);if(console.log("res data import",g),g.status==="error")throw new Error(g.message||"Terjadi kesalahan sistem");Swal.fire({icon:"success",title:"Berhasil!",text:`Import selesai! ${g.processed_rows||0} data berhasil diproses.`,timer:2e3,showConfirmButton:!1}).then(b=>{(b.isConfirmed||b.dismiss===Swal.DismissReason.timer)&&reloadCallback()})}catch(g){Swal.close();let b="Terjadi Kesalahan",_="Gagal memproses permintaan.";g.message.includes("sistem")||g.message.includes("500")?(b="System Error",_="Mohon maaf, sistem sedang mengalami kendala teknis."):(b="Gagal Import",_=g.message),Swal.fire({icon:"error",title:b,text:_,confirmButtonText:"Oke"})}})}function Ee(){const e=document.querySelector(".btn-download-template");e&&e.addEventListener("click",async t=>{t.preventDefault(),Swal.fire({title:"Unduh Template?",text:"Pastikan untuk tidak mengubah header dan kolom dalam template agar tidak terjadi kesalahan saat mengimpor.",icon:"question",showCancelButton:!0,confirmButtonText:"Ya, download sekarang",cancelButtonText:"Batal",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33"}).then(a=>{if(a.isConfirmed){Swal.fire({title:"Sedang mengunduh...",text:"Mohon tunggu sebentar.",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});try{window.location.href="/training/download-template",setTimeout(()=>{Swal.close(),Swal.fire({icon:"success",title:"Berhasil!",text:"Template Excel berhasil diunduh.",timer:2e3,showConfirmButton:!1})},2e3)}catch(n){console.error("Error download:",n),Swal.fire({icon:"error",title:"Gagal!",text:"Terjadi kesalahan saat mengunduh template."})}}})})}function Te(e){if(!e)return;const t=e.querySelector("#lna-pengajuan-form"),a=e.querySelector(".js-select-unit");!t||!a||(De(a),Ie(t),t.addEventListener("submit",async function(n){n.preventDefault();const i=new FormData(t);de(e),Swal.fire({title:"Menyimpan Data...",text:"Harap tunggu sebentar",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{const r=await C("/training/training-request/input-lna",i);if(Swal.close(),r.status!=="success"){Swal.fire({icon:"error",title:"Gagal Menyimpan",text:r.message||"Terjadi kesalahan saat menyimpan data."});return}await Swal.fire({icon:"success",title:"Berhasil!",text:r.message||"Data berhasil disimpan.",timer:1500,showConfirmButton:!1}),t.reset();const o=e.getAttribute("data-table-id");o&&A.reload(o)}catch(r){Swal.close(),console.error(r),Swal.fire({icon:"error",title:"Kesalahan Server",text:"Terjadi kesalahan pada server. Silakan coba lagi."})}}))}function De(e){if(!e)return;const t=window.currentUnitId,a=window.currentUnitName;if(!t){console.warn("autoSetUnit: User tidak memiliki unit");return}e.innerHTML="";const n=document.createElement("option");n.value=t,n.textContent=a||"Unit tidak ditemukan",n.selected=!0,e.appendChild(n),e.disabled=!0}function Ie(e){const t=e.querySelector("input[name='biaya_pelatihan']");if(!t)return;t.addEventListener("input",()=>{const n=t.value.replace(/[^\d]/g,"");t.value=a(n)});function a(n){return n?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(Number(n)):""}}const L={tables:{selector:".training-table",dataAttributes:{role:"data-role",unitId:"data-unit-id"}},tabs:{container:"#training-tabs",panelSelector:".u-tabs__panel",activeClass:"is-active",hiddenClass:"hidden"},buttons:{downloadTemplate:".btn-download-template",bulkApprove:"#btn-bulk-approve",allApprove:"#btn-all-approve"}},Ce=(e,t=null)=>{const a=window[e];return a??(console.warn(`Global variable '${e}' is not defined, using default:`,t),t)},Le=()=>{const e=document.querySelector(".u-tabs__panel:not(.hidden)");e&&e.querySelectorAll(L.tables.selector).forEach(t=>{Z(`#${t.id}`,{unitId:window.currentUnitId})})},qe=()=>{const e=document.querySelector("#training-tabs");if(!e)return;const t=e.querySelectorAll(".u-tabs__item"),a=document.querySelectorAll(".u-tabs__panel");t.forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.tab;i&&(t.forEach(r=>{r.classList.remove("border-blue-600","text-slate-900","u-font-semibold"),r.classList.add("border-transparent","text-slate-400")}),n.classList.remove("border-transparent","text-slate-400"),n.classList.add("border-blue-600","text-slate-900","u-font-semibold"),a.forEach(r=>{r.classList.toggle("hidden",r.id!==`tab-${i}`)}),setTimeout(()=>{const r=document.getElementById(`tab-${i}`);r&&r.querySelectorAll(L.tables.selector).forEach(o=>{Z(`#${o.id}`,{unitId:window.currentUnitId})})},50))})})};function Be(){[{id:"#input-training-modal",init:ve},{id:"#lna-import-modal",init:je},{id:"#lna-input-modal",init:_e},{id:"#lna-pengajuan-modal",init:Te}].forEach(({id:t,init:a})=>{const n=document.querySelector(t);n&&(n.dataset.initialized||(a(n),n.dataset.initialized="true"))})}const Me=()=>{document.querySelector(L.buttons.downloadTemplate)&&(console.log("Initializing download template handler"),Ee())},Oe=()=>{const t=["currentUserRole","userUnitId"].filter(a=>!window[a]);return t.length>0?(console.warn("Missing global variables:",t),!1):!0},$e=()=>{try{Ce("currentUserRole")||console.warn("window.currentUserRole is not defined. Tables must have data-role attribute."),qe(),Le(),Be(),Me(),console.log("Training page initialization completed successfully")}catch(e){console.error("Error during training page initialization:",e)}},Pe={init:$e,config:L,utils:{validateEnvironment:Oe}};document.addEventListener("DOMContentLoaded",()=>{console.log("Training page initialized"),Pe.init()});
